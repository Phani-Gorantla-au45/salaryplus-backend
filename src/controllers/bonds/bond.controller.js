import Bond from "../../models/bonds/bond.model.js";

/* ---------------- CREATE BOND LISTING (ADMIN) ---------------- */
export const createBond = async (req, res) => {
  try {
    // 1️⃣ Get latest bondLaunchId from DB
    const lastBond = await Bond.findOne({})
      .sort({ bondLaunchId: -1 })
      .select("bondLaunchId");

    // 2️⃣ Decide next number
    let nextNumber = 1;

    if (lastBond?.bondLaunchId) {
      nextNumber = Number(lastBond.bondLaunchId) + 1;
    }

    const bondLaunchId = String(nextNumber).padStart(4, "0");
    const {
      bondName,
      isin,
      issuerName,
      faceValue,
      availableUnits,
      totalUnits,
      ytm,
      couponRate,
      interestPayoutFrequency,
      principalPayoutFrequency,
      maturityDate,
      couponBasis,
      security,
      securityCover,
      guaranteeType,
      collateral,
      investmentAmount,
      repaymentPriority,
      rating,
      ratingAgency,
      ratingDate,
      debentureTrustee,
      status,
    } = req.body;

    const bond = await Bond.create({
      bondLaunchId, // generated by backend
      bondName,
      isin,
      issuerName,
      faceValue,
      availableUnits,
      totalUnits,
      ytm,
      couponRate,
      interestPayoutFrequency,
      principalPayoutFrequency,
      maturityDate,
      couponBasis,
      security,
      securityCover,
      guaranteeType,
      collateral,
      investmentAmount,
      repaymentPriority,
      rating,
      ratingAgency,
      ratingDate,
      debentureTrustee,
      status,
    });

    return res.status(201).json({
      success: true,
      message: "Bond listing created successfully",
      data: bond,
    });
  } catch (error) {
    if (error.code === 11000) {
      return res.status(409).json({
        success: false,
        message: "Bond with same ISIN already exists",
      });
    }

    return res.status(500).json({
      success: false,
      message: error.message,
    });
  }
};

/* ---------------- GET ALL BOND LISTINGS ---------------- */
export const getBondListings = async (req, res) => {
  try {
    const bonds = await Bond.find(
      {},
      {
        _id: 0,
        __v: 0,
      },
    ).sort({ createdAt: -1 });

    return res.status(200).json({
      success: true,
      data: bonds,
    });
  } catch (error) {
    return res.status(500).json({
      success: false,
      message: error.message,
    });
  }
};
export const getBondByBondLaunchId = async (req, res) => {
  try {
    const { bondLaunchId } = req.params;

    if (!bondLaunchId) {
      return res.status(400).json({
        success: false,
        message: "bondLaunchId is required",
      });
    }

    const bond = await Bond.findOne(
      { bondLaunchId },
      {
        _id: 0,
        __v: 0,
      },
    ).lean();

    if (!bond) {
      return res.status(404).json({
        success: false,
        message: "Bond not found for this bondLaunchId",
      });
    }

    return res.status(200).json({
      success: true,
      data: bond,
    });
  } catch (error) {
    return res.status(500).json({
      success: false,
      message: error.message,
    });
  }
};

/* ---------------- UPDATE BOND LISTING BY bondLaunchId (ADMIN) ---------------- */
export const updateBondByBondLaunchId = async (req, res) => {
  try {
    const { bondLaunchId } = req.params;

    if (!bondLaunchId) {
      return res.status(400).json({
        success: false,
        message: "bondLaunchId is required",
      });
    }

    const {
      bondName,
      isin,
      issuerName,
      faceValue,
      availableUnits,
      totalUnits,
      ytm,
      couponRate,
      interestPayoutFrequency,
      principalPayoutFrequency,
      maturityDate,
      couponBasis,
      security,
      securityCover,
      guaranteeType,
      collateral,
      investmentAmount,
      repaymentPriority,
      rating,
      ratingAgency,
      ratingDate,
      debentureTrustee,
      status,
    } = req.body;

    const updatedBond = await Bond.findOneAndUpdate(
      { bondLaunchId },
      {
        bondName,
        isin,
        issuerName,
        faceValue,
        availableUnits,
        totalUnits,
        ytm,
        couponRate,
        interestPayoutFrequency,
        principalPayoutFrequency,
        maturityDate,
        couponBasis,
        security,
        securityCover,
        guaranteeType,
        collateral,
        investmentAmount,
        repaymentPriority,
        rating,
        ratingAgency,
        ratingDate,
        debentureTrustee,
        status,
      },
      {
        new: true,
        runValidators: true,
        projection: { _id: 0, __v: 0 },
      },
    );

    if (!updatedBond) {
      return res.status(404).json({
        success: false,
        message: "Bond not found for this bondLaunchId",
      });
    }

    return res.status(200).json({
      success: true,
      message: "Bond listing updated successfully",
      data: updatedBond,
    });
  } catch (error) {
    if (error.code === 11000) {
      return res.status(409).json({
        success: false,
        message: "Bond with same ISIN already exists",
      });
    }

    return res.status(500).json({
      success: false,
      message: error.message,
    });
  }
};
